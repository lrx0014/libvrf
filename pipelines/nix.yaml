steps:
- task: CmdLine@2
  displayName: 'Bootstrap vcpkg'
  inputs:
    script: |
      cd $(Build.SourcesDirectory)
      git clone https://github.com/microsoft/vcpkg.git
      cd vcpkg
      ./bootstrap-vcpkg.sh -disableMetrics
    workingDirectory: '$(Build.SourcesDirectory)'
    failOnStderr: false

- task: CMake@1
  displayName: 'Configure libvrf'
  inputs:
    cmakeArgs: >
      -S .
      -B build
      -GNinja
      -DCMAKE_BUILD_TYPE='${{ parameters.configuration }}'
      -DLIBVRF_BUILD_TESTS=ON
      -DLIBVRF_BUILD_BENCHMARKS=ON
      -DCMAKE_TOOLCHAIN_FILE=$(Build.SourcesDirectory)/vcpkg/scripts/buildsystems/vcpkg.cmake
    workingDirectory: '$(Build.SourcesDirectory)'

- task: CMake@1
  displayName: 'Build libvrf'
  inputs:
    cmakeArgs: >
      --build build
      --config '${{ parameters.configuration }}'
    workingDirectory: '$(Build.SourcesDirectory)'

- task: CmdLine@2
  displayName: 'Run libvrf unit tests'
  inputs:
    script: 'build/bin/vrf_tests'
    workingDirectory: '$(Build.SourcesDirectory)'
